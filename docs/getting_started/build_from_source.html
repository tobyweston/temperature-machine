<html><head><title>Temperature Machine</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Toby Weston" /><meta name="description" content="The homebrew data logger" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Temperature Machine" /><meta name="og:site_name" content="Temperature Machine" /><meta name="og:url" content="http://temperature-machine.com" /><meta name="og:type" content="website" /><meta name="og:description" content="The homebrew data logger" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Temperature Machine" /><meta name="twitter:image" content="http://temperature-machine.comimg/poster.png" /><meta name="twitter:description" content="The homebrew data logger" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/overrides.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-3327317-12' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Temperature Machine</span></div></a></li> <li><a href="/docs/index.html" class="">Introduction</a></li> <li><a href="/docs/getting_started.html" class="">Getting Started</a> <ul class="sub_section"> <li><a href="/docs/getting_started/installing.html" class="">Installing</a></li> <li><a href="/docs/getting_started/build_from_source.html" class="">Build from Source</a></li> <li><a href="/docs/getting_started/raspbian_setup.html" class="">Raspbian Setup</a></li></ul></li> <li><a href="/docs/getting_help.html" class="">Getting Help</a></li> <li><a href="/docs/ds18b20_sensor.html" class="">DS18B20 Sensor</a></li> <li><a href="/docs/add-on_board.html" class="">Add-on Board</a></li> <li><a href="/docs/rrd.html" class="">RRD</a></li> <li><a href="/docs/hacking.html" class="">Hacking</a> <ul class="sub_section"> <li><a href="/docs/hacking/sbt_plugins.html" class="">SBT Plugins</a></li> <li><a href="/docs/hacking/release.html" class="">Releasing</a></li></ul></li> <li><a href="/docs/ansible.html" class="">Ansible Automation</a> <ul class="sub_section"> <li><a href="/docs/ansible/getting_started.html" class="">Getting Started</a></li> <li><a href="/docs/ansible/useful_commands.html" class="">Useful Ad-hoc Commands</a></li></ul></li> <li><a href="/docs/resources.html" class="">Resources</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tobyweston/temperature-machine"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tobyweston/temperature-machine"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Temperature Machine The homebrew data logger');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Temperature Machine The homebrew data logger');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tobyweston" data-github-repo="temperature-machine"><div class="content-wrapper"><section><h1 id="build-from-source-">Build From Source <img src="https://travis-ci.org/tobyweston/temperature-machine.svg?branch=master" alt="" /></h1>

<h2 id="prerequisites">Prerequisites</h2>

<p>You’ll need Java installed on your Pi (<code class="language-plaintext highlighter-rouge">sudo apt-get install openjdk-8-jdk</code>), Git (<code class="language-plaintext highlighter-rouge">sudo apt-get install git</code>) and SBT.</p>

<h3 id="install-sbt">Install SBT</h3>

<p>To setup <code class="language-plaintext highlighter-rouge">sbt</code> manually, follow these steps from the terminal.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /usr/local/bin
sudo wget https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.16/sbt-launch.jar
sudo chown pi sbt-launch.jar
sudo chgrp pi sbt-launch.jar
</code></pre></div></div>

<p>Create a file <code class="language-plaintext highlighter-rouge">/usr/local/bin/sbt</code> (change the owner and group as above) and paste the following in (take note that the max memory is set to 512 MB for the Pi Zero). Change the owner and group as above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
SBT_OPTS="-Xms512M -Xmx512M"
java $SBT_OPTS -jar `dirname $0`/sbt-launch.jar "$@"
</code></pre></div></div>

<p>Then make it executable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod u+x /usr/local/bin/sbt
</code></pre></div></div>

<p>Or if you prefer the official install, these steps (from <a href="http://www.scala-sbt.org/0.13/docs/Installing-sbt-on-Linux.html">scala-sbt.org</a>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "deb https://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
sudo apt-get install dirmngr --install-recommends
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
sudo apt-get update
sudo apt-get install sbt
</code></pre></div></div>

<h2 id="building">Building</h2>

<p>The general approach to get the software on the box, I tend to do the following.</p>

<ol>
  <li>Clone the Git repository on the Pi</li>
  <li>(Recommended) increase your swap file size (see <a href="build_from_source.html#increase-swap-file-size">below</a>)</li>
  <li>Run <code class="language-plaintext highlighter-rouge">sbt -J-Xmx512m -J-Xms512m assembly</code> from a terminal (memory set low for the Pi Zero). This might take around 30m on the Pi Zero.</li>
  <li>Run <code class="language-plaintext highlighter-rouge">./start.sh &amp;</code> from the checked out folder</li>
</ol>

<blockquote>
  <p>Don’t forget to enable 1-wire support by adding <code class="language-plaintext highlighter-rouge">dtoverlay=w1-gpio</code> to <code class="language-plaintext highlighter-rouge">/boot/config.txt</code></p>
</blockquote>

<p>You can also read my <a href="http://baddotrobot.com/blog/2016/03/23/homebrew-temperature-logger/">blog post</a> for more detailed instructions and the <a href="../configuration.html">configuration section</a> to find out how to start automatically on boot.</p>

<h2 id="keep-up-to-date">Keep up to Date</h2>

<p>Keep your source up to date by getting the latest from Git (<code class="language-plaintext highlighter-rouge">git pull</code>) and compiling with <code class="language-plaintext highlighter-rouge">sbt assembly</code>.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">cd ~/code/temperature-machine</code></li>
  <li><code class="language-plaintext highlighter-rouge">git pull</code></li>
  <li><code class="language-plaintext highlighter-rouge">sbt -J-Xmx512m -J-Xms512m assembly</code></li>
</ol>

<p>This is the “in-development” version of the software. It may have partially implemented features or be broken completely. Check that the build is at least passing (below) before you update and if you prefer, stick to <a href="download.html">downloading</a> the <a href="https://github.com/tobyweston/temperature-machine/releases">official releases</a> as an alternative.</p>

<h2 id="tips-and-troubleshooting">Tips and Troubleshooting</h2>

<h3 id="always-run-as-pi">Always run as <code class="language-plaintext highlighter-rouge">pi</code></h3>

<p>All the steps assume you’re running as the <code class="language-plaintext highlighter-rouge">pi</code> user. <strong><mark>Never run anything to do with temperature-machine as root</mark></strong>.</p>

<h3 id="increase-swap-file-size">Increase Swap File Size</h3>

<p>SBT seems to struggle on the Pi and <code class="language-plaintext highlighter-rouge">assembly</code> will frequently fail. It uses incremental compilation so running a second time after a failure picks up from where it left off and will generally succeed.</p>

<p>However, if you increase the swap size on the Pi (especially effective on the Pi Zero), you should have fewer problems.</p>

<p>Edit <code class="language-plaintext highlighter-rouge">/etc/dphys-swapfile</code> to increase the swap file size:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo nano /etc/dphys-swapfile
</code></pre></div></div>

<p>Replace:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONF_SWAPSIZE=100
</code></pre></div></div>

<p>with…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONF_SWAPSIZE=512
</code></pre></div></div>

<p>Recreate the swap file with the following.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /etc/init.d/dphys-swapfile restart
</code></pre></div></div>

<p>Check by running <code class="language-plaintext highlighter-rouge">free -m</code>. The total value for swap should be <code class="language-plaintext highlighter-rouge">512</code> (ish) (and not <code class="language-plaintext highlighter-rouge">99</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            434          98         174           3         161         285
Swap:           511           0          511
</code></pre></div></div>

<p>Thanks to Cristian Arezzini for this tip.</p>

<h3 id="failing-build">Failing Build</h3>

<p>An SBT build should end with a success message. Something like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
[warn] Strategy 'discard' was applied to 11 files
[info] SHA-1: 5f0a3316b670b1249256892d76322b0ddec9e47a
[info] Packaging /home/pi/code/temperature-machine/target/scala-2.12/temperature-machine-2.1.jar ...
[info] Done packaging.
[success] Total time: 1688 s, completed 18-Jan-2018 19:29:18
</code></pre></div></div>

<p>Anything else is a failure.</p>

<p>Failures will be either environmental (problems with the Pi like memory or general flakeyness) or problems with the code (doesn’t compile or tests fail). If it’s environmental, follow the steps above: rerun and/or increase the swap file size. Here’s an example of a environmental failure during compilation.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Compiling 29 Scala sources to /home/pi/code/temperature-machine/target/scala-2.12/test-classes...
/usr/local/bin/sbt: line 3:  6014 Killed                  java $SBT_OPTS -jar `dirname $0`/sbt-launch.jar "$@"
</code></pre></div></div>

<p>If it’s a compilation or test failure, you’ll need to reach out (see the <a href="../getting_help.html">Getting Help</a> section).</p>

<h3 id="skipping-tests">Skipping Tests</h3>

<p>If you want to skip running the tests as part of the assembly process, use the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt 'set test in assembly := {}' assembly 
</code></pre></div></div>

<h3 id="starting-and-stopping">Starting and Stopping</h3>

<p>If you build from source, you’ll have to start and stop the application manually.</p>

<p>Use the following commands respectively.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./start.sh
./stop.sh
</code></pre></div></div>

<h3 id="starting-automatically">Starting Automatically</h3>

<p>There are lots of different ways to start software automatically after a reboot. You might choose to add following to <code class="language-plaintext highlighter-rouge">/etc/rc.local</code> (for a longer term solution, follow the <a href="installing.html">installation</a> instructions and run as a service).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su pi -c 'cd /home/pi/code/temperature-machine &amp;&amp; ./start.sh &amp;'
</code></pre></div></div>

<p>It uses the configuration file (see <a href="getting_started/installing.html">Installing</a> section) to select between server and clients so ensure the configuration file exists in the <code class="language-plaintext highlighter-rouge">~/.temperature</code> folder.</p>

<p>The command runs the start script as the user <code class="language-plaintext highlighter-rouge">pi</code> and assumes you’ve cloned the code as to <code class="language-plaintext highlighter-rouge">/home/pi/code/temperature-machine</code>. After a reboot, it will execute and you should see a log file in <code class="language-plaintext highlighter-rouge">~/.temperature</code> and pid file in the startup folder.</p>

<p>To stop, just run the <code class="language-plaintext highlighter-rouge">stop.sh</code> script.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'temperature-machine/Lobby'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>